---
title: "R Notebook"
output: html_notebook
---

# Load packages in

```{r}
pacman::p_load(sf, readr, tidyverse, tmap)
```

# Load Data in

## Geospatial Data

```{r}
seoul <- st_read(dsn = "data_final/seoul_adm2",
                 layer= "seoul_adm2") %>%
  st_transform(crs = 5179)
```

```{r}
clinics <- st_read(dsn = "data_final/seoul_clinics",
                   layer = "seoul_clinics") %>%
  st_transform(crs = 5179)
hospitals <- st_read(dsn = "data_final/seoul_hospitals",
                     layer = "seoul_hospitals") %>%
  st_transform(crs = 5179)
residence <- st_read(dsn = "data_final/seoul_residential",
                     layer = "seoul_residential") %>%
  st_transform(crs = 5179)
road <- st_read(dsn="data_final/seoul_roads",
                layer = "seoul_roads_v2")%>%
  st_transform(crs = 5179)
```

## Select wanted datasets

```{r}
clinic <- clinics %>%
  select(1,3)
hospitals <- hospitals %>%
  select(1,3)
residence <- residence %>%
  select(1,3)
road <- road %>%
  select(1,3)
```

## Aspatial Data

```{r}
population <- read_csv("data_final/population_seoul.csv")
```

# Data Wrangling

## Geospatial

```{r}
pop <- population %>%
  select(1,2) %>%
  mutate(Elderly_pop = round(0.1758*`Total population (Person)`,0)) %>%
  rename(name_en =`By administrative divisions(eup, myeon, dong)`)
```

```{r}
Gu <- pop$name_en

seoul <- seoul %>%
  filter(name_en %in% Gu) %>%
  select(name_en)
```

```{r}
seoul_pop <- seoul %>%
  left_join(pop,
             by = "name_en") 
```

```{r, eval = FALSE}
st_write(seoul_pop,
         dsn = "data_final",
         layer = "seoul_pop",
         driver = "ESRI Shapefile")
```

```{r, eval = FALSE}
seoul_pop <- st_read(dsn = "data_final/",
                     layer = "seoul_pop")
```

```{r}
tm_shape(seoul_pop)+
  tm_fill("Elderly_pop", 
          style = "quantile", 
          palette = "Greens",
          title = "Elderly Population") +
  tm_layout(main.title = "Elderly Population",
            main.title.position = "center",
            main.title.size = 1.2,
            legend.height = 0.45, 
            legend.width = 0.35,
            frame = TRUE) +
  tm_borders(alpha = 0.5) +
  tm_compass(type="8star", size = 2) +
  tm_scale_bar() +
  tm_grid(alpha =0.2) +
  tm_credits("Source: Data.korea", 
             position = c("left", "bottom")) +
  tmap_style("classic")
```

# Start of Network Constrained Spatial Point

## Packages needed

```{r}
pacman::p_load(sf, spNetwork)
```

```{r}
roads_by_gu <- st_intersection(road, seoul)
hospital_by_gu <- st_intersection(hospitals, seoul)
residence_by_gu <- st_intersection(residence, seoul)
```

Ensure datasets are in the right format for NKDE

```{r}
hospital_by_gu <- st_centroid(hospital_by_gu)
residence_by_gu <- st_centroid(residence_by_gu)
```

```{r}
if ("MULTILINESTRING" %in% st_geometry_type(roads_by_gu)){
  converted <- st_cast(roads_by_gu[which(st_geometry_type(roads_by_gu) == "MULTILINESTRING"),], "LINESTRING")
  linestring <- roads_by_gu[which(st_geometry_type(roads_by_gu) == "LINESTRING"),]
  roads_by_gu_new<- rbind(linestring, converted)
}
```

```{r}
roads_by_gwanak <- roads_by_gu_new %>%
  filter(name_en == "Gwanak-gu")
hospital_by_gwanak <- hospital_by_gu %>%
  filter(name_en == "Gwanak-gu")
residence_by_gwanak <- residence_by_gu %>%
  filter(name_en == "Gwanak-gu")
```

```{r}
tmap_mode("view")
tm_shape(roads_by_gwanak) +
  tm_lines() +
  tm_shape(hospital_by_gwanak) +
  tm_dots(col = "green") +
  tm_shape(residence_by_gwanak) +
  tm_dots(col = "red")
```

## Preparing lixels object

```{r}
# Filter out only LINESTRING geometries
lixels <- lixelize_lines(roads_by_gwanak, 700, mindist = 350)

```

## Generating line centre points

```{r}
samples <- lines_center(lixels)
```

## Performing NetKDE

```{r}
hospital_by_gwanak_sp <- as_Spatial(hospital_by_gwanak)
```

```{r}
densities <- nkde(roads_by_gwanak, 
                  events = hospital_by_gwanak,
                  w = rep(1,nrow(hospital_by_gwanak)),
                  samples = samples,
                  kernel_name = "quartic",
                  bw = 300, 
                  div= "bw", 
                  adaptive = FALSE,
                  method = "continuous", 
                  digits = 1, 
                  tol = 1,
                  grid_shape = c(1,1), 
                  max_depth = 8,
                  agg = 20, #we aggregate events within a 5m radius (faster calculation)
                  sparse = TRUE,
                  verbose = FALSE)
```

## Visualising NETKDE

```{r}
samples$density <- densities*1000
lixels$density <- densities*1000
```

```{r}
tmap_mode('view')
tm_shape(lixels)+
  tm_lines(col="density")
```

## Network constrained G and K function

**Ho: The observed spatial point events (i.e distribution of childcare centres) are uniformly distributed over a street network in Punggol Planning Area.**

```{r}
kfun_hospital <- kfunctions(roads_by_gwanak, 
                             hospital_by_gwanak,
                             start = 0, 
                             end = 30, 
                             step = 1, 
                             width = 50, 
                             nsim = 50, 
                             resolution = 50,
                             verbose = FALSE, 
                             conf_int = 0.05)
```

```{r}
kfun_hospital$plotk
```

### Geographical accessibility

### Using Euclidean Distance

```{r}
library(sf)
library(rgeos)
library(od)


```

# Dong level![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAaCAYAAADFTB7LAAAAcElEQVR4Xu3OwQmAQAxE0bClWYCW5N06tM6V2YPg5CjoF/JhLoHAi6iqn9eOefUbqrYvHY0cQDLyAlKRNyARmYA0ZMLRkAlGQyaU72tkAtlim7r/vJqDUDjlKBROOQyFU2icQuMUGqfQuBEaV1XPOwEx96nYACK8+wAAAABJRU5ErkJggg== "Run Current Chunk")

```{r}
ihwa <- seoul %>%
  filter(name_en == "Ihwa-dong")
```

```{r}
hospital_ihwa <- st_intersection(hospitals, ihwa)
roads_ihwa <- st_intersection(road, ihwa)
residence_ihwa <- st_intersection(residence, ihwa)
```

```{r}
if ("MULTILINESTRING" %in% st_geometry_type(roads_ihwa)){
  converted <- st_cast(roads_ihwa[which(st_geometry_type(roads_ihwa) == "MULTILINESTRING"),], "LINESTRING")
  linestring <- roads_ihwa[which(st_geometry_type(roads_ihwa) == "LINESTRING"),]
  roads_ihwa_line<- rbind(linestring, converted)}
```

```{r}
Roads_ihwa_sp <- as_Spatial(roads_ihwa_line)
```

```{r}
# Filter out only LINESTRING geometries
lixels <- lixelize_lines(roads_ihwa_sp, 700, mindist = 350)
hospital_by_ihwa_sp <- as_Spatial(hospital_ihwa)

densities <- nkde(roads_ihwa, 
                  events = hospital_ihwa,
                  w = rep(1,nrow(hospital_ihwa)),
                  samples = samples,
                  kernel_name = "quartic",
                  bw = 300, 
                  div= "bw", 
                  adaptive = FALSE,
                  method = "continuous", 
                  digits = 1, 
                  tol = 1,
                  grid_shape = c(1,1), 
                  max_depth = 8,
                  agg = 20, #we aggregate events within a 5m radius (faster calculation)
                  sparse = TRUE,
                  verbose = FALSE)
kfun_hospital$plotk
```

```{r}
tmap_mode('view')
tm_shape(lixels)+
  tm_lines(col="density")
```
